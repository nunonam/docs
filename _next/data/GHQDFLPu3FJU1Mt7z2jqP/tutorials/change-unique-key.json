{"pageProps":{"frontmatter":{"title":"Change single unique key","subtitle":"Three step process for changing a table's single unique or primary key"},"headings":[{"depth":2,"value":"Overview"},{"depth":2,"value":"How to change a table's single unique key"},{"depth":2,"value":"Why?"},{"depth":2,"value":"Summary"}],"body":{"compiledSource":"var u=Object.defineProperty,c=Object.defineProperties;var y=Object.getOwnPropertyDescriptors;var r=Object.getOwnPropertySymbols;var i=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable;var l=(e,a,t)=>a in e?u(e,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[a]=t,o=(e,a)=>{for(var t in a||(a={}))i.call(a,t)&&l(e,t,a[t]);if(r)for(var t of r(a))p.call(a,t)&&l(e,t,a[t]);return e},s=(e,a)=>c(e,y(a));var h=(e,a)=>{var t={};for(var n in e)i.call(e,n)&&a.indexOf(n)<0&&(t[n]=e[n]);if(e!=null&&r)for(var n of r(e))a.indexOf(n)<0&&p.call(e,n)&&(t[n]=e[n]);return t};const makeShortcode=e=>function(t){return console.warn(\"Component \"+e+\" was not imported, exported, or provided by MDXProvider as global scope\"),mdx(\"div\",o({},t))},InfoBlock=makeShortcode(\"InfoBlock\"),layoutProps={},MDXLayout=\"wrapper\";function MDXContent(t){var n=t,{components:e}=n,a=h(n,[\"components\"]);return mdx(MDXLayout,s(o(o({},layoutProps),a),{components:e,mdxType:\"MDXLayout\"}),mdx(\"h2\",null,\"Overview\"),mdx(\"p\",null,\"To migrate data safely and \",mdx(\"a\",o({parentName:\"p\"},{href:\"/concepts/nonblocking-schema-changes\"}),\"without downtime\"),\", PlanetScale requires that all tables have a unique, not-null key that remains unchanged during the migration. This requirement can cause difficulty if, for example, you attempt to ALTER the primary key of a table with no other unique keys.\"),mdx(\"p\",null,\"If you attempt to deploy such a schema change, the deploy request will fail with the error \",mdx(\"inlineCode\",{parentName:\"p\"},\"All tables must have at least one unique, not-null key that remains unchanged during the migration\"),\".\"),mdx(InfoBlock,{type:\"note\",mdxType:\"InfoBlock\"},\"This example adds a temporary unique key but you could also use a unique index or create the temporary key by adding a unique constraint.\"),mdx(\"h2\",null,\"How to change a table's single unique key\"),mdx(\"p\",null,\"Altering a single unique key can be accomplished in 3 steps. Each step is a \",mdx(\"a\",o({parentName:\"p\"},{href:\"/concepts/branching#deploying-branches\"}),\"separate deploy request\"),\".\"),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},mdx(\"p\",{parentName:\"li\"},\"Add a temporary unique key. To change a lone unique key you will first need to add another unique key that PlanetScale can use during the migration. In a new branch, add a new key on a unique column or combination of columns. The target columns should not contain null values.\"),mdx(\"pre\",{parentName:\"li\"},mdx(\"code\",o({parentName:\"pre\"},{}),\"ALTER TABLE table_name ADD UNIQUE KEY temp_unique_key (`column`,`column2`);\\n\")),mdx(\"p\",{parentName:\"li\"},\"Deploy this change via a deploy request.\")),mdx(\"li\",{parentName:\"ol\"},mdx(\"p\",{parentName:\"li\"},\"Alter the original key. Now that you have a second unique key, you can alter the original key. In a new branch, apply your intended schema change.\"),mdx(\"p\",{parentName:\"li\"},\"Our example drops the existing primary key and replaces it with a compound primary key.\"),mdx(\"pre\",{parentName:\"li\"},mdx(\"code\",o({parentName:\"pre\"},{}),\"ALTER TABLE table_name DROP PRIMARY KEY, ADD PRIMARY KEY(`column`,`column2`);\\n\")),mdx(\"p\",{parentName:\"li\"},\"Deploy this change via a deploy request.\")),mdx(\"li\",{parentName:\"ol\"},mdx(\"p\",{parentName:\"li\"},\"Drop the temporary unique key. After the primary key has been updated, you can remove the temporary unique key that you added in Step 1.\"),mdx(\"p\",{parentName:\"li\"},\"In a new branch, drop the temporary key.\"),mdx(\"pre\",{parentName:\"li\"},mdx(\"code\",o({parentName:\"pre\"},{}),`ALTER TABLE table_name DROP KEY temp_unique_key;\n`)),mdx(\"p\",{parentName:\"li\"},\"Once this deploy request has been deployed, you will have changed your table's unique primary key and removed the temporary unique key created in step 1.\"))),mdx(\"h2\",null,\"Why?\"),mdx(\"p\",null,`PlanetScale's non-blocking schema changes works by first creating a ghost table, in the likeness of your original table. The ghost table is then altered to match your changed schema.\nWe copy over the data from the original table, as well as stream any changes as they happen to the ghost table. Once this ghost table is in sync with the original, we swap the tables in place. This safely completes the migration.`),mdx(\"p\",null,\"To do this, we need to have a consistent primary or unique key across both of the tables to reliability replicate the data over. This is why we require a consistent key when migrating your data.\"),mdx(\"h2\",null,\"Summary\"),mdx(\"p\",null,\"This tutorial provides a three step process for updating a table's single unique key and can be repeated as often as needed.\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"fields":{"slug":"tutorials/change-unique-key","lastUpdatedOn":"2021-12-25T02:12:47.189Z"}},"__N_SSG":true}